<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta and links -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Note PT Sanoh Indonesia</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="../../assets/icon_sanoh.png">

    <!-- Styles -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f2f2f2;
        }

        .container {
            width: 210mm;
            max-width: 100%;
            min-height: 297mm;
            height: auto;
            padding: 20px;
            background-color: #fff;
            box-sizing: border-box;
            margin: 0 auto;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #000;
            padding: 10px;
            background-color: #fff;
            margin-bottom: 20px;
        }

        .logo {
            width: 110px;
            margin-right: 10px;
        }

        .logo img {
            width: 100%;
        }

        .company-info {
            text-align: left;
            flex-grow: 5;
            font-size: 9px;
        }

        .delivery-note {
            text-align: right;
            font-size: 11px;
        }

        .details {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between; /* Menyelaraskan bagian details */
            font-size: 10px; /* Mengatur ukuran font untuk details */
        }

        .details-left, .details-right {
            width: 60%; /* Mengatur lebar untuk bagian details */
            margin-bottom: 1px;
            margin-left: 3px;
            margin-right: 30px; /* Jarak antar details */
            padding-right: 130px; /* Menambahkan padding di kanan */
        }

        .details-right {
            font-size: 10px;    /* Mengatur ukuran font */
            text-align: right; /* Menyelaraskan teks ke kanan */
            padding-right: 0px; /* Menambahkan padding di kanan */
        }

        .details-left {
            text-align: left; /* Mengatur teks agar rata kiri */
            font-size: 10px; /* Mengatur ukuran font menjadi 12px sesuai permintaan */
        }

        /* Styling khusus delivery-left*/
        .detail-item {
            display: flex; /* Mengatur elemen label dan nilai dalam satu baris */
            justify-content: flex-start; /* Menyelaraskan elemen di awal baris */
            line-height: 1.5; /* Memberikan jarak antar baris untuk keterbacaan */
        }

        .detail-item strong {
            min-width: 130px; /* Memberikan lebar minimum pada label agar rata dan konsisten */
        }

        .detail-item span {
            margin-left: 10px; /* Menambahkan jarak antara label (strong) dan nilai (span) */
        }

        /* Styling khusus untuk PO Number */
        .details-left .detail-item:last-child {
            font-weight: normal; /* Membuat PO Number tebal */
            font-size: 10px;    /* Mengatur ukuran font */
        }

        /* Styling khusus untuk Total Box */
        .details-right .detail-item:last-child {
            margin-top: 20px; /* Menambahkan jarak di atas elemen Total Box */
            display: flex;
            justify-content: flex-end; /* Menyelaraskan elemen ke ujung kanan */
            align-items: center; /* Menyelaraskan elemen secara vertikal di tengah */
        }

        .total-box {
            display: flex; /* Mengatur elemen secara horizontal */
            align-items: center; /* Menyelaraskan elemen di tengah secara vertikal */
        }

        .box-label {
            font-size: 10px;    /* Ukuran font untuk label "Total Box" */
            color: #000;        /* Warna hitam untuk label */
            margin-right: 2px; /* Jarak antara "Total Box" dan angka */
        }

        .box-number {
            font-size: 12px;    /* Ukuran font untuk angka */
            font-weight: bold;  /* Membuat angka tebal */
            color: #000;        /* Warna hitam untuk angka */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 9px;
        }

        table, th, td {
            border: 0.5px solid #000;
            padding: 4px 8px;
            word-wrap: break-word;
        }

        thead th {
            text-align: center;
            vertical-align: middle;
            background-color: #ffffff;
            color: black;
        }

        tbody td {
            text-align: center;
            vertical-align: middle;
        }

        tbody td:nth-child(2),
        tbody td:nth-child(3) {
            text-align: left;
        }

        th {
            background-color: #ffffff;
            color: black;
            text-align: center;
            font-size: 9px;
        }

        td {
            text-align: center;
            vertical-align: middle;
        }

        th:nth-child(1),
        td:nth-child(1),
        th:nth-child(4),
        td:nth-child(4),
        th:nth-child(5),
        td:nth-child(5),
        th:nth-child(6),
        td:nth-child(6),
        th:nth-child(7),
        td:nth-child(7),
        th:nth-child(8),
        td:nth-child(8),
        th:nth-child(9),
        td:nth-child(9) {
            width: 8%;
        }

        th:nth-child(2),
        td:nth-child(2) {
            text-align: center;
            width: 35%;
        }

        th:nth-child(3),
        td:nth-child(3) {
            text-align: center;
            width: 30%;
        }

        .note {
            margin-bottom: 20px;
            font-size: 10px;
        }

        .note p {
            font-style: italic;
            font-size: 11px;
            line-height: 1.6;
        }

        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .signature-section .supplier,
        .signature-section .sanoh {
            width: 48%;
        }

        .signature-section h3 {
            text-align: left;
            margin-bottom: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .signature-section table {
            width: 100%;
            border-collapse: collapse;
            height: 100px;
            table-layout: fixed;
        }

        .signature-section th,
        .signature-section td {
            border: 1px solid black;
            padding: 4px;
            text-align: left;
            vertical-align: top;
            font-size: 10px;
            height: 5px;
        }

        .signature-section th {
            font-weight: bold;
            background-color: #ffffff;
            text-align: left;
            font-size: 10px;
            padding: 4px;
        }

        .signature-section td p {
            margin: 0;
            padding: 0;
            font-size: 10px;
        }

        .signature-section td {
            height: 50px;
        }
    </style>

</head>

<body>

    <div class="container">
        <div id="page-content"></div>
    </div>
    <!-- Page Content Container -->

    <!-- Include html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <!-- Include your API script if needed -->
    <script src="../../api.js"></script>
    <!-- Include your custom script if needed -->
    <script src="../../script.js"></script>

    <script>
    // Retrieve the noDN from the URL
    const noDN = getQueryParams();

    // Validate the noDN value
    if (!noDN || noDN.trim() === "" || noDN === 'undefined' || noDN === null) {
        console.error("Invalid noDN value:", noDN);
        document.getElementById('page-content').innerHTML = "<p>Error: Invalid or missing Delivery Note number.</p>";
    } else {
        // If noDN is valid, fetch and display the Delivery Note data
        fetchDeliveryNoteData(noDN).then(data => {
            renderDeliveryNote(data);
            generatePDF(data.dn_number);
        });
    }

    // Main function to handle token retrieval and fetching DN data
    (async function main() {
        try {
            // First, get the token and ensure it's valid
            const token = await getToken();

            // Then, if token is valid, proceed to fetch the Delivery Note data
            if (token && noDN) {
                const data = await fetchDeliveryNoteData(noDN, token);
                renderDeliveryNote(data);
                generatePDF(data.dn_number);
            } else {
                throw new Error("Token or Delivery Note number is invalid.");
            }
        } catch (error) {
            console.error("Error in main execution:", error);
            document.getElementById('page-content').innerHTML = "<p>Error: Invalid or missing token or Delivery Note number.</p>";
        }
    })();


    // Function to retrieve token from localStorage
    async function getToken() {
        return new Promise((resolve, reject) => {
            const token = localStorage.getItem('accessToken');
            if (token) {
                resolve(token);
            } else {
                reject("Access token is missing. Please log in again.");
            }
        });
    }

    function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const noDN = params.get('noDN');  // Retrieve noDN from the URL
        console.log("noDN from URL:", noDN);  // Debugging: Check if it's retrieved correctly

        // Return the noDN (even if it's undefined)
        return noDN;
    }

    // Function to fetch Delivery Note data using the noDN from the URL and token
    async function fetchDeliveryNoteData(noDN, token) {
        try {
            const response = await fetch(`${API_dnViewSupplier}${noDN}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const dnData = await response.json();

            if (dnData.success && dnData.data && dnData.data.length > 0) {
                // Format the data as needed
                const formattedData = {
                    dn_number: dnData.data[0].dn_number,
                    po_number: dnData.data[0].po_number,
                    supplier_name: dnData.data[0].supplier_name,
                    supplier_code: dnData.data[0].supplier_code,
                    planned_receipt_date: dnData.data[0].planned_receipt_date,
                    total_box: dnData.data[0].detail.reduce((sum, detail) => sum + calculateNoOfKanban(detail.total_quantity, detail.pcs_per_kamban), 0),
                    printed_date: dnData.data[0].printed_date,
                    detail: dnData.data[0].detail.map(detail => ({
                        delivery_note_detail_id: detail.delivery_note_detail_id,
                        dn_number: detail.dn_number,
                        line_no: detail.line_no,
                        supplier_part_number: detail.supplier_part_number,
                        internal_part_number: detail.internal_part_number,
                        part_name: concatenatePartName(detail.part_name),
                        pcs_per_kamban: detail.pcs_per_kamban,
                        qty_confirm: detail.qty_confirm,
                        no_of_kamban: calculateNoOfKanban(detail.total_quantity, detail.pcs_per_kamban),
                        total_quantity: detail.total_quantity,
                        box_quantity: calculateNoOfKanban(detail.total_quantity, detail.pcs_per_kamban),
                    }))
                };

                return formattedData;
            } else {
                console.error("No data available:", dnData.message);
                return null;
            }
        } catch (error) {
            console.error("Error fetching Delivery Note data:", error);
            return null;
        }
    }

    // Helper function to concatenate part descriptions
    function concatenatePartName(part_name) {
        return part_name;
    }

    // Helper function to calculate no_of_kanban
    function calculateNoOfKanban(quantity, snp) {
        return quantity / snp;
    }

    function renderHeader(header) {
        return `
            <header class="header">
                <div class="logo">
                    <img src="../../assets/logo-sanoh.png" alt="Sanoh Logo">
                </div>
                <div class="company-info">
                    <p><b>PT. SANOH INDONESIA</b> <br>Jl. Inti II, Blok C-4 No.10, Kawasan Industri Hyundai, Cikarang, Kab. Bekasi<br>
                        Phone +62 21 89907963</p>
                </div>
                <div class="delivery-note">
                    <h3>DELIVERY NOTE<br><span id="dnNumber">${header.dn_number || 'N/A'}</span></h3>
                </div>
            </header>
        `;
    }

    function renderDetails(header) {
        return `
            <div class="details">
                <div class="details-left">
                    <div class="detail-item">
                        <strong>Supplier Code</strong> <span id="supplierCode">: ${header.supplier_code || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Supplier Name</strong> <span id="supplierName">: ${header.supplier_name || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>DN Number</strong> <span id="dnNumberDetail">: ${header.dn_number || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>PO Number</strong> <span id="poNumber">: ${header.po_number || 'N/A'}</span>
                    </div>
                </div>
                <div class="details-right">
                    <div class="detail-item">
                        <strong>Planned Received Date</strong> <span id="plannedReceivedDate">: ${header.planned_receipt_date || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Actual Received Date</strong> <span id="actualReceivedDate">: _______________</span>
                    </div>
                    <div class="detail-item">
                        <div class="total-box">
                            <strong class="box-label">Total Box</strong>
                            <span id="totalBox" class="box-number">${header.total_box || '0'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderSignatureSection(header) {
        return `
            <div class="note">
                <p><b>NOTE: </b> <br> 1. Untuk penggunaan PO Number pada Surat Jalan Supplier, harap mengikuti PO Number di atas<br>
                2. Saat Delivery ke Sanoh membawa form ini sebagai bukti delivery<br>
                3. Form ini juga sebagai Checksheet Receiving Supplier<br>
                4. Confirmation Supplier wajib diisi</p>
            </div>
            
            <div class="signature-section">
                <div class="supplier">
                    <h5>SUPPLIER</h5>
                    <table>
                        <tr>
                            <th style="width: 33.33%; text-align: center; font-size: 10px;">LOGISTIK</th>
                            <th style="width: 33.33%; text-align: center; font-size: 10px;">CONTROLLER</th>
                            <th style="width: 33.33%; text-align: center; font-size: 10px;">DRIVER</th>                        
                        </tr>
                        <tr>
                            <th>    <br><br><br>    </th>
                            <th>    <br><br><br>    </th>
                            <th>    <br><br><br>    </th>
                        </tr>
                        <tr>
                            <th>Name:</th>
                            <th>Name:</th>
                            <th>Name:</th>
                        </tr>
                        <tr>
                            <th>Date:</th>
                            <th>Date:</th>
                            <th>Date:</th>
                        </tr>
                    </table>
                </div>
                <div class="sanoh">
                    <h5>PT.SANOH INDONESIA</h5>
                    <table>
                        <tr>
                            <th style="width: 50%; text-align: center; font-size: 10px;">RECEIVER</th>
                            <th style="width: 50%; text-align: center; font-size: 10px;">CONTROLLER</th>             
                        </tr>
                        <tr>
                            <th>    <br><br><br>    </th>
                            <th>    <br><br><br>    </th>
                        </tr>
                        <tr>
                            <th>Name:</th>
                            <th>Name:</th>
                        </tr>
                        <tr>
                            <th>Date:</th>
                            <th>Date:</th>
                        </tr>
                    </table>
                </div>
            </div>
        `;
    }

    function renderTable(header, items) {
        let pageContent = '';
        const rowsPerPage = 20;
        const totalPages = Math.ceil(items.length / rowsPerPage) || 1;

        for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
            const startIndex = pageIndex * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, items.length);
            const pageItems = items.slice(startIndex, endIndex);

            pageContent += `
                    <div class="container">
                        ${renderHeader(header)}
                        ${renderDetails(header)}
                        <table class="table-page ${pageIndex === totalPages - 1 ? 'last-page' : ''}">
                            <thead>
                                <tr>
                                    <th id="no-1" rowspan="2">No.</th>
                                    <th id="supplier-part-no-1" colspan="1">Supplier Part No.</th>
                                    <th id="part-name-1" rowspan="2">Part Name</th>
                                    <th id="pcs-kbn-1" rowspan="2">Pcs/Kbn</th>
                                    <th id="no-of-kbn-1" rowspan="2">No of Kbn</th>
                                    <th id="total-qty-1" rowspan="2">Total Qty</th>
                                    <th id="confirmation-1" colspan="2">Confirmation</th>
                                    <th id="box-qty-1" rowspan="2">Box Qty</th>
                                </tr>
                                <tr>
                                    <th id="internal-part-no-1">Internal Part No.</th>
                                    <th id="supp-1">Supp.</th>
                                    <th id="sanoh-1">Sanoh</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                // Add rows for this page
                pageItems.forEach((item, index) => {
                    const rowNumber = startIndex + index + 1;
                    pageContent += `
                        <tr>
                            <td>${rowNumber}</td>
                            <td><b>${item.supplier_part_number || 'N/A'}</b><br>${item.internal_part_number || 'N/A'}</td>
                            <td>${item.part_name || 'N/A'}</td>
                            <td>${item.pcs_per_kamban || '0'}</td>
                            <td>${item.no_of_kamban || '0'}</td>
                            <td>${item.total_quantity || '0'}</td>
                            <td>${item.qty_confirm || ''}</td>
                            <td>${item.confirmation_sanoh || ''}</td>
                            <td>${item.box_quantity || '0'}</td>
                        </tr>
                    `;
                });

                pageContent += `
                            </tbody>
                        </table>
                `;

                if (pageIndex === totalPages -1) {
                    pageContent += `
                        ${renderSignatureSection(header)}
                    `;
                }

                pageContent += `
                    </div>
                `;

                if (pageIndex !== totalPages - 1) {
                    pageContent += `<div class="page-break"></div>`;
                }
            }

        return pageContent;
    }
    

    // Function to render the Delivery Note
    function renderDeliveryNote(header) {
        const items = header.detail || [];
        const pageContent = `
            <div class="container">
                ${renderTable(header, items)}
            </div>
        `;

        // Inject the rendered content into the page
        document.getElementById('page-content').innerHTML = pageContent;
    }

    function generatePDF(dnNumber) {
        const element = document.getElementById('page-content');

        const opt = {
            margin:       0,
            filename:     dnNumber ? `DeliveryNote_${dnNumber}.pdf` : 'DeliveryNote.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            window.history.back();
        });
    }

    </script>
</body>
</html>
