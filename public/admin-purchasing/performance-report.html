<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Berkshire+Swash&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <link rel="icon" type="image/png" href="../assets/icon_sanoh.png">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="font-poppins bg-white">
  <section class="overflow-hidden w-screen h-screen bg-white">
    <div class="flex h-screen">

      <!-- nav-side bar -->
      <aside class="flex flex-col w-[20%] h-screen border-r border-r-neutral-400 bg-stone-300">
        <nav class="flex flex-col grow py-9 2xl:py-14 text-base font-medium">

          <!-- Logo Sanoh -->
          <img loading="lazy" src="../assets/logosanoh.svg"
            class="object-contain self-center w-30 2xl:w-48 max-w-full cursor-pointer" />

          <!-- Menu Items -->
          <ul class="flex flex-col mt-7 2xl:mt-10 w-full text-gray-500">
            <!-- Dashboard -->
            <li>
              <a href="index.html"
                class="flex gap-4 items-center p-[9px] 2xl:p-4 w-full cursor-pointer hover:bg-blue fvv-800 hover:bg-opacity-5 hover:border-l-8 hover:border-blue-950">
                <img loading="lazy" src="../assets/icon_home_default.svg" alt="Dashboard"
                  class="object-contain w-4 2xl:w-6" />
                <span class="text-sm 2xl:text-xl">Dashboard</span>
              </a>
            </li>

            <!-- Purchase Order -->
            <li>
              <a href="purchase-order.html"
                class="flex gap-4 items-center p-[9px] 2xl:p-4 mt-4 w-full cursor-pointer hover:bg-blue-800 hover:bg-opacity-5 hover:border-l-8 hover:border-blue-950">
                <img loading="lazy" src="../assets/icon_po_default.svg" alt="Purchase Order"
                  class="object-contain w-4 2xl:w-6" />
                <span class="text-sm 2xl:text-xl">Purchase Order</span>
              </a>
            </li>

            <!-- History Purchase Order -->
            <li>
              <a href="history-purchase-order.html"
                class="flex gap-4 items-center p-[9px] 2xl:p-4 mt-4 w-full cursor-pointer hover:bg-blue-800 hover:bg-opacity-5 hover:border-l-8 hover:border-blue-950">
                <img loading="lazy" src="../assets/icon_history_default.svg" alt="History Purchase Order"
                  class="object-contain w-4 2xl:w-6" />
                <span class="text-sm 2xl:text-xl">History Purchase Order</span>
              </a>
            </li>

            <!-- Performance Report -->
            <li>
              <a
                class="flex gap-4 items-center p-[9px] 2xl:p-4 mt-4 w-full cursor-pointer hover:bg-blue-800 hover:bg-opacity-5 hover:border-l-8 hover:border-blue-950 active">
                <img loading="lazy" src="../assets/icon_performance_default.svg" alt="Performance Report"
                  class="object-contain w-4 2xl:w-6 icon-performance-active" />
                <span class="text-sm 2xl:text-xl">Performance Report</span>
              </a>
            </li>
          </ul>

          <!-- User and Logout Section at the Bottom -->
          <div class="mt-auto flex flex-col w-full">
            <!-- User Info -->
            <div class="flex gap-4 items-center p-2 2xl:p-4 w-full bg-blue-950 bg-opacity-10 text-blue-950">
              <img loading="lazy" src="../assets/icon_people.svg" alt="User Info" class="object-contain w-4 2xl:w-6" />
              <span id="user-info" class="text-sm 2xl:text-xl"></span>
            </div>

            <!-- Logout Button -->
            <a href="javascript:void(0)" onclick="handleLogout()"
              class="flex gap-4 items-center p-2 2xl:p-4 w-full text-red-600 whitespace-nowrap cursor-pointer pointer-events-auto bg-red-600 bg-opacity-20 hover:bg-red-600 hover:text-green-50 hover:logout-icon">
              <img loading="lazy" src="../assets/icon_logout.svg" alt=""
                class="object-contain shrink-0 self-stretch my-auto w-4 2xl:w-6 aspect-square logout-icon hover:icon_logout_white.svg" />
              <span class="self-stretch my-auto text-sm 2xl:text-xl">Logout</span>
            </a>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex flex-col w-[80%] mb-auto mt-[3%] mx-auto px-6 2xl:px-10">

        <section class="flex flex-col self-stretch py-px my-auto w-full ">

          <header class="flex gap-3 items-center self-start text-2xl font-semibold text-black">
            <h1 class="self-stretch my-auto text-[80%] 2xl:text-[120%]">Performance Report</h1>
          </header>

          <article class="flex flex-col items-start w-full text-base">
            <h1 class="text-base 2xl:text-xl font-semibold text-black mt-4">Select Supplier</h1>
          </article>
          
          <form id="supplierForm" class="flex flex-col w-full text-neutral-500">
            <div class="flex flex-col xl:w-[500px] 2xl:w-[600px]">
              <label for="Supplier" class="block xl:mb-6 2xl:mb-8 xl:text-base 2xl:text-lg text-neutral-500"></label>
              <select id="supplier_id"
                class="scrollable-select bg-transparent border border-neutral-300 rounded-lg block w-full p-4 2xl:p-7 text-neutral-500 text-sm 2xl:text-lg">
                <option value="">Search Supplier</option>
                <!-- Options will be added here by JavaScript -->
              </select>
            </div>
          </form>
         

           <!-- Add File Section -->
          <form id="upload-file">
            <div id="addFileSection" class="flex flex-col mt-6 2xl:mt-8 2xl:text-base text-xs font-medium hidden">
              <div class="flex items-center mb-4  ">
                <label for="month-picker" class="mr-4 text-base 2xl:text-xl">Periode :</label>
                <input type="month" id="month-picker" class=" pl-4 pr-4 border rounded-md" required>
              </div>

              <div class="flex items-center mb-4">
                <label for="file-upload" class=" text-base 2xl:text-xl">Add File :</label>
                <input type="file" id="file-upload" class="rounded-md p-2 ml-2 text-gray-600" required>
                
                <button id="upload-button"
                  class="px-4 py-2 bg-gray-400 text-white text-xs 2xl:text-base rounded-md" disabled>
                  Upload
                </button>
              </div>
            </div>
          </form>

          <!-- Periode Section -->
          <div id="periodeSection" class="items-center mt-4 hidden">
            <div class="flex items-center">
              <input type="month" id="month-input" class="px-4 border rounded-md" />
              <button id="search-button" class="ml-4 px-4 py-2 bg-blue-500 text-white text-xs 2xl:text-base rounded-md">
                Search
              </button>
            </div>
          </div>

        </section>

        <!-- Notifikasi -->
        <div id="notification" class="fixed top-4 right-4 bg-green-500 text-white p-4 rounded-md shadow-md hidden">
          Data berhasil ditambahkan!
        </div>

        <!-- Table Section -->
        <div id="tableSection" class="flex flex-col mt-5 2xl:mt-8 hidden">
          <div class="relative overflow-x-auto shadow-md rounded-lg border border-gray-300">

            <table class="w-full text-[11px] 2xl:text-base text-left text-gray-700 dark:text-gray-700">
              <thead class="text-[14px] 2xl:text-[20px] text-gray-700">
                <tr>
                  <th scope="col" class="px-2 2xl:py-4 py-3 text-center border-b border-b-gray-400 cursor-pointer " data-sort="no" " >
                    No
                  </th>
                  <th scope="col" class="px-2 2xl:py-4 py-3 text-center border-b border-b-gray-400 cursor-pointer" data-sort="periode" onclick="sortTable(1)">
                   Periode
                    <img loading="lazy" src="../assets/icon_sort.svg" alt=""
                    class="w-3 2xl:w-4 inline-block text-gray-600" />
                    <span class="sort-indicator"></span>
                  </th>
                  <th scope="col" class="px-2 2xl:py-4 py-3 text-center border-b border-b-gray-400 cursor-pointer" data-sort="filename">
                    FIle Name
                  </th>
                  <th scope="col" class="px-2 2xl:py-4 py-3 text-center border-b border-b-gray-400 cursor-pointer" data-sort="attachedFile">
                    Attached File
                    <span class="sort-indicator"></span>
                  </th>
                  <th scope="col" class="px-2 2xl:py-4 py-3 text-center border-b border-b-gray-400 cursor-pointer" onclick="sortTable(2)">
                    Created At
                    <img loading="lazy" src="../assets/icon_sort.svg" alt="" class="w-3 2xl:w-4 inline-block text-gray-600" />
                    <span class="sort-indicator"></span>
                  </th>                  
                </tr>
              </thead>
              <tbody id="table-body-detail">
                <!-- Data rows will be inserted here by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        <div id="paginationSection" class="flex justify-end my-6 hidden">
          <div class="flex gap-2 2xl:gap-4 items-center pagination">
            <!-- Pagination buttons will be inserted here by JavaScript -->
          </div>
        </div>
      </main>
    </div>
  </section>

</body>

<script src="script.js"></script>
<script src="../api.js"></script>
<script src="../script.js"></script>
<script src="../table.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Add the script to handle table sorting and pagination -->
<script>

  cekToken();

  document.addEventListener('DOMContentLoaded', () => {

    fetchSuppliers();
    adjustRowsPerPage();
    window.addEventListener('resize', () => {
      adjustRowsPerPage();
      displayTableData(currentPage);
      updatePagination();
    });

    const supplierSelect = document.getElementById('supplier_id');
    const form = document.getElementById('upload-file');
    const uploadButton = document.getElementById('upload-button');
    const fileUpload = document.getElementById('file-upload');
    const monthPicker = document.getElementById('month-picker');

    // Set default value of month-picker and month-input to current month
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Months are zero-based
    const currentMonth = `${year}-${month}`;
    document.getElementById('month-picker').value = currentMonth;


    // const selectedSupplierId = $('#supplier_id').val(); 

    $(supplierSelect).on('change', async function (event) {
      const selectedSupplierId = $(this).val();
      console.log('Supplier dipilih:', selectedSupplierId);


      if (selectedSupplierId) {
        // Tampilkan section setelah supplier dipilih
        document.getElementById('addFileSection').classList.remove('hidden');
        document.getElementById('periodeSection').classList.remove('hidden');
        document.getElementById('tableSection').classList.remove('hidden');
        document.getElementById('paginationSection').classList.remove('hidden');
        
        localStorage.setItem('selectedSupplierId', selectedSupplierId);

        // Panggil fetchPerformanceReport untuk memperbarui data tabel berdasarkan supplier yang dipilih
        await fetchPerformanceReport(selectedSupplierId);
        displayTableData(currentPage);
        updatePagination();
      } else {
        // Sembunyikan section jika tidak ada supplier yang dipilih
        document.getElementById('addFileSection').classList.add('hidden');
        document.getElementById('periodeSection').classList.add('hidden');
        document.getElementById('tableSection').classList.add('hidden');
        document.getElementById('paginationSection').classList.add('hidden');
      }
    });

    fileUpload.addEventListener('change', () => {
      if (fileUpload.files.length) {
        console.log('File selected:', fileUpload.files[0].name); // Debugging line
        uploadButton.disabled = false;
        uploadButton.classList.remove('bg-gray-400');
        uploadButton.classList.add('bg-blue-500', 'hover:bg-blue-700');

      } else {
        uploadButton.disabled = true;
        uploadButton.classList.remove('bg-blue-500', 'hover:bg-blue-700');
        uploadButton.classList.add('bg-gray-400');
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // Prevent form from submitting traditionally

      const file = fileUpload.files[0];
      let period = monthPicker.value;
      period = `${period}-05`;
      console.log(period);      
      const supplierId = localStorage.getItem('selectedSupplierId');
      const valid = validateForm(file, period, supplierId);

      
      if (valid) {
        const uploadButton = document.getElementById('upload-button');

        // Tampilkan spinner dengan mengubah innerHTML
        uploadButton.innerHTML = `
          <svg aria-hidden="true" role="status" class="inline w-4 h-4 me-3 text-white animate-spin" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="#E5E7EB"/>
            <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentColor"/>
          </svg>
          Uploading...
        `;

        uploadButton.disabled = true;

        try {
          await uploadFile(token, supplierId, file, period); // Tambahkan bpCode saat memanggil uploadFile
        } finally {
          // Kembalikan tombol ke teks "Upload" setelah selesai
          uploadButton.innerHTML = 'Upload';
          uploadButton.disabled = false;

          // Reset file input
          fileUpload.value = '';
          uploadButton.disabled = true;
          uploadButton.classList.remove('bg-blue-500', 'hover:bg-blue-700');
          uploadButton.classList.add('bg-gray-400');

        }
      }
    });

    document.getElementById('search-button').addEventListener('click', async () => {
      const selectedMonth = document.getElementById('month-input').value;
      const supplierId = localStorage.getItem('selectedSupplierId');

      if (selectedMonth) {
        await fetchPerformanceReport(supplierId, selectedMonth);  // Panggil fetchPerformanceReport dengan parameter bulan yang dipilih
        displayTableData(currentPage);
        updatePagination();
      } else {
        alert('Silakan pilih periode.');
      }
    });

    // addSortingListeners(); // Tambahkan event listener untuk sorting
  });


  async function fetchSuppliers() {
    const token = localStorage.getItem('accessToken');
    try {
      const response = await fetch(APIpartner3, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          // suppliersData = data.data;
          // populateSupplierDropdown(suppliersData);
          populateSupplierDropdown(data.data);
        } else {
          console.error('Failed to fetch suppliers:', data.message);
        }
        
      } else {
        console.error('Kesalahan saat mengambil data supplier:', response.status, response.statusText);
      }
    } catch (error) {        
      console.error('Error Token Not Valid', error);
    }
  }

  // Fungsi untuk mengisi dropdown supplier
  function populateSupplierDropdown(suppliersData) {
    const supplierSelect = document.getElementById('supplier_id');
    // Populate options...
    suppliersData.forEach(supplier => {
      const option = document.createElement('option');
      option.value = supplier.bp_code;
      option.textContent = `${supplier.bp_code} | ${supplier.bp_name}`;
      supplierSelect.appendChild(option);
    });

    // Initialize Select2
    $(supplierSelect).select2({
      placeholder: 'Search Supplier',
      allowClear: true
    });
  }


  async function fetchPerformanceReport(supplierId, selectedMonth = null) {
    const token = localStorage.getItem('accessToken');
  
    if (!supplierId) {
      alert('Supplier belum dipilih.');
      return;
    }
  
    try {
      const response = await fetch(`${APIindexlistingreport}/${supplierId}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
  
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
  
      const result = await response.json();
      console.log('Data listing report:', result); // Debugging

      if (result.success) {
        originalData = result.data.map(item => ({
          no: item.po_listing_no,
          periode: formatDate(item.date),
          upload_at: item.upload_at,
          filedata: item.file,
          attachedFile: item.file
        }));

        if (selectedMonth) {
          // Filter data berdasarkan bulan yang dipilih
          filteredData = originalData.filter(row => {
            const rowMonth = row.periode.slice(0, 7); // Ambil bagian YYYY-MM dari tanggal
            return rowMonth === selectedMonth;
          });
        } else {
          filteredData = [...originalData]; // Jika tidak ada bulan yang dipilih, tampilkan semua data
        }
        // Urutkan data berdasarkan 'upload_at' secara menurun (terbaru duluan)
        filteredData.sort((a, b) => new Date(b.upload_at) - new Date(a.upload_at));

        displayTableData(currentPage);
        updatePagination();
      } else {
        console.error('Gagal mengambil data:', result.message);
        alert(`Gagal mengambil data: ${result.message}`);
      }
    } catch (error) {
      console.error('Error fetching data:', error);
      alert(`Error fetching data: ${error.message}`);
    }
  }
  
  async function uploadFile(token, supplierId, file, period) {
    
  
    const formData = new FormData();
    formData.append('file', file);
    formData.append('date', period);
    formData.append('bp_code', supplierId);
  
    try {
      const response = await fetch(APIuploadlisting, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });

      // Cek status respons
      const textResponse = await response.text();
      console.log("Response from server:", textResponse); // Log respons lengkap

      // Ubah kembali ke JSON jika respons valid
      const result = JSON.parse(textResponse);
      if (response.ok && result.status) {
        displayNotification('Success uploading file','success');
        await fetchPerformanceReport(supplierId); // Refresh data setelah upload
        displayTableData(currentPage); // Perbarui tampilan tabel
      } else {
        displayNotification(`Error: ${result.message}`);
      }
    } catch (error) {
      console.error('Error uploading file:', error);
      displayNotification(`Error uploading file: ${error.message}`);
    }
  }


  function getFileIcon(filename) {
    const extension = filename.split('.').pop().toLowerCase(); // Get the file extension

    switch (extension) {
      case 'pdf':
          return `<img src="../assets/icon_pdf.svg" alt="PDF Icon" class="w-6 h-6" />`;
      case 'doc':
          return `<img src="../assets/icon_doc.svg" alt="png Icon" class="w-6 h-6" />`;
      case 'docx':
          return `<img src="../assets/icon_docx.svg" alt="Word Icon" class="w-6 h-6" />`;
      case 'jpg':
      case 'jpeg':
          return `<img src="../assets/icon_jpg.svg" alt="png Icon" class="w-6 h-6" />`;
      case 'png':
          return `<img src="../assets/icon_png.svg" alt="png Icon" class="w-6 h-6" />`;
      case 'xls':
      case 'xlsx':
          return `<img src="../assets/icon_excel.svg" alt="Excel Icon" class="w-6 h-6" />`;
      default:
          return `<img src="../assets/icon_file.svg" alt="File Icon" class="w-6 h-6" />`;
    }
  }


  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toISOString().split('T')[0]; // Format to YYYY-MM-DD
  }

  function displayTableData(page) {
    const tableBody = document.getElementById('table-body-detail');
    if (!tableBody) {
        console.error('Table body element not found!');
        return;
    }

    tableBody.innerHTML = '';

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedData = filteredData.slice(start, end);

    paginatedData.forEach((row, index) => {
        const tableRow = document.createElement('tr');
        tableRow.classList.add('odd:bg-white', 'even:bg-gray-50', 'border-b');
        const rowNumber = start + index + 1;

        // Pisahkan angka dan nama file dengan memanfaatkan split dan slice
        const fileName = row.filedata.split('_').slice(1).join('_');

        // Konversi periode ke format "Month YYYY"
        const periodDate = new Date(row.periode);
        const formattedPeriod = periodDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });

        tableRow.innerHTML = `
          <td class="px-2 py-4 text-center font-medium text-gray-900">${rowNumber}</td>
          <td class="px-2 py-4 text-center">${formattedPeriod}</td>
          <td class="px-1 py-4 w-[30%] text-center">${fileName}</td>          
          <td class="px-1 py-2 text-center flex items-center justify-center">
            <a href="${APIreadfile}${row.attachedFile}" download>
              ${getFileIcon(row.attachedFile)}
            </a>
          </td>
          <td class="px-2 py-4 text-center">${row.upload_at}</td>
        `;
        tableBody.appendChild(tableRow);
    });
}

  function adjustRowsPerPage() {
    if (window.innerHeight < 768) {
      rowsPerPage = 4; // Atur menjadi 3 jika ukuran layar < 768
    } else if (window.innerHeight < 1280) {
      rowsPerPage = 5; // Atur menjadi 4 jika ukuran layar >= 768
    } else {
      rowsPerPage = 6;
    }
  }

  function validateForm(file, period, supplierId) {
    if (!file) {
      alert('Silakan pilih file untuk diunggah.');
      return false;
    }
    if (!period) {
      alert('Silakan pilih periode.');
      return false;
    }
    if (!supplierId) {
      alert('Silakan pilih supplier.');
      return false;
    }
    return true;
  }

</script>

</html>